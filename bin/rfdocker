#!/usr/bin/env bash

set -e

### globals ####################################################################

this_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
rf_version=$(cat "$this_path/../rf_version")

### main #######################################################################

if [ -z "$TESTS_PATH" ]; then
  echo "[rfdocker] Error: Set 'TESTS_PATH' to where 'tests/' is found, e.g.:"
  echo ""
  echo "TESTS_PATH=../tests/ $0 $@"
  exit 64
fi

tests_path="$(cd "$TESTS_PATH" && pwd)"

if [ -z "$RESULTS_PATH" ]; then
  echo "[rfdocker] Variable 'RESULTS_PATH' is not explicitly set for outputs"
  echo "[rfdocker] -> assuming $this_path/results/"
  echo ""
  results_path="$this_path/results"
else
  results_path="$(cd "$RESULTS_PATH" && pwd)"
fi

echo "[rfdocker] Using local Docker image 'rfdocker:$rf_version'"
echo "[rfdocker] Ensure you have built this with $this_path../scripts/build.sh"
echo ""

docker run --rm -ti \
  -e UNAME="robot" \
  -e GNAME="robot" \
  -e UID=$(id -u) \
  -e GID=$(id -g) \
  -v "$results_path":/home/robot/results \
  -v "$tests_path":/home/robot/tests \
  "rfdocker:$rf_version" "${@:-tests}"
